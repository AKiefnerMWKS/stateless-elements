import*as e from"react";import{createContext as t,useRef as n,createElement as o,useContext as i,useCallback as r,useEffect as s,useMemo as d,useState as a,Fragment as l}from"react";import{createEventEmitter as c,DisposableCollection as p}from"@stoplight/lifecycle";import{configure as h,runInAction as u,observable as g,action as m,computed as f}from"mobx";import{Classes as v,Menu as y,ContextMenu as N,Icon as b,EditableText as x,Intent as w}from"@stoplight/ui-kit";import D from"classnames";import{observer as E}from"mobx-react-lite";import{FixedSizeList as C}from"@stoplight/ui-kit/ScrollList";import O from"react-error-boundary";var k,j;function T(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&(n[o[i]]=e[o[i]])}return n}function R(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var d=e.length-1;d>=0;d--)(i=e[d])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}function I(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function P(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function d(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,d)}a((o=o.apply(e,t||[])).next())})}!function(e){e.NodeClick="node.click",e.NodeMouseEnter="node.mouseenter",e.NodeMouseLeave="node.mouseexit",e.NodeDoubleClick="node.doubleClick",e.NodeCaretClick="node.caretClick",e.Drop="drop",e.EditCancel="edit.cancel",e.BeforeEditComplete="edit.beforecomplete",e.AfterEditComplete="edit.aftercomplete"}(k||(k={})),function(e){e.Right="right",e.Down="down"}(j||(j={}));const S=e=>"canHaveChildren"in e&&!!e.canHaveChildren,L=e=>null===e.id,Z=e=>"index"in e,_=(e,t)=>Z(t)?t.index:e.findIndex(({id:e})=>t.id===e),M=(e,t,n)=>void 0===n||n.index>t?e[t]:n.index===t?n:e[t-1],z=(e,t)=>{if(0===t.level)return H;let n=_(e,t);if(-1===n)return;if(0===n)return H;let o=t;for(;n>0&&o.level!==t.level-1;)o=e[--n];return o},A=(e,t,n)=>{let o=0;if(!L(t)){if(-1===(o=_(e,t)))return[];o++}const i=L(t)?[]:[t];for(;o<e.length;){const r=e[o];if(void 0!==n&&n.id===r.id)break;if(!L(t)&&r.level<=t.level)break;i.push(e[o]),o++}return i},$=(e,t)=>{const n=_(e,t),o=[];let i=n,r=n;for(;--i>=0;){const n=e[i];if(n.level===t.level-1)break;n.level===t.level&&o.push(n)}for(;++r<e.length;){const n=e[r];if(n.level===t.level-1)break;n.level===t.level&&o.push(n)}return o},H=Object.freeze({id:null}),G=Symbol("DROP_ZONE_ID"),B=800,F=15,K=30;h({enforceActions:"observed"});class U extends(c()){constructor(e){super(),this.nodes=[],this.expanded={},this.icons={},this.defaultExpandedDepth=0,this.setActiveNode=(e=>{this.activeNodeId=e}),this.setEditedNode=(e=>{this.editedNodeId=e}),this.toggleExpand=((e,t)=>{const{expanded:n}=this;"boolean"==typeof t&&t===n[e.id]||(this.expanded[e.id]=void 0!==t?t:!this.isNodeExpanded(e))}),this._knownPossibleDepth=0,this.create=((e,t,n)=>P(this,void 0,void 0,function*(){let o=0;if(null!==e&&-1===(o=this.filteredNodes.findIndex(({id:t})=>t===e.id)))throw new Error(`Node with id: ${e.id} was not found.`);const i=null===e?H:this.filteredNodes[o++];if(L(i)||S(i)){L(i)||this.toggleExpand(i,!0);const e=Object.assign({name:"",id:""},t,{index:o,level:L(i)?0:i.level+1});u(()=>{this.newNode=e});try{return yield this.rename(e,n)}finally{u(()=>{this.newNode=void 0})}}throw new Error})),this.rename=((e,t)=>P(this,void 0,void 0,function*(){this.setEditedNode(e.id);const n=new p;try{return yield new Promise((e,o)=>{n.pushAll([this.on(k.BeforeEditComplete,(e,n)=>{void 0!==t&&t(e,n)}),this.on(k.AfterEditComplete,e),this.on(k.EditCancel,o)])})}finally{n.dispose(),this.setEditedNode()}})),void 0!==e&&Object.assign(this,e)}isNodeExpanded(e){return!(e.id in this.expanded)&&e.level<=this.defaultExpandedDepth||!0===this.expanded[e.id]}get knownPossibleDepth(){return this._knownPossibleDepth}get filteredNodes(){const e=[];if(0===this.nodes.length)return this._knownPossibleDepth=0,e;const t=[""];let n=null;for(const o of this.nodes){const i=null===n||n.level>=o.level;i&&!this.isNodeExpanded(o)&&(n=o),o.canHaveChildren&&o.level+1>this.knownPossibleDepth&&(this._knownPossibleDepth=o.level+1),t.length=o.level+1,t[t.length-1]=o.id,void 0===o[G]&&(o[G]=`-${t.join("-")}-`),i&&(n!==o&&(n=null),e.push(o))}return e}}R([g,I("design:type",String)],U.prototype,"activeNodeId",void 0),R([g,I("design:type",String)],U.prototype,"editedNodeId",void 0),R([g.ref,I("design:type",Object)],U.prototype,"newNode",void 0),R([g.shallow,I("design:type",Array)],U.prototype,"nodes",void 0),R([g,I("design:type",Object)],U.prototype,"expanded",void 0),R([g,I("design:type",Object)],U.prototype,"icons",void 0),R([g,I("design:type",Object)],U.prototype,"defaultExpandedDepth",void 0),R([m,I("design:type",Object)],U.prototype,"setActiveNode",void 0),R([m,I("design:type",Object)],U.prototype,"setEditedNode",void 0),R([m,I("design:type",Object)],U.prototype,"toggleExpand",void 0),R([f,I("design:type",Object),I("design:paramtypes",[])],U.prototype,"filteredNodes",null),R([m,I("design:type",Object)],U.prototype,"create",void 0),R([m,I("design:type",Object)],U.prototype,"rename",void 0);class W{constructor(){this.attach=(e=>{document.body.appendChild(this.node),e.dataTransfer.setDragImage(this.node,-10,-10),setTimeout(this.detach,0)}),this.detach=(()=>{this.node.remove()}),this.node=document.createElement("span"),this.node.className=D(v.TAG,v.ROUND)}get content(){return this.node.textContent}set content(e){this.node.textContent=e}}const X=e=>Object.entries(e).map(e=>e.join(":")).join(";");function Y(e){const t=document.createElement("style");return t.textContent=e,document.body.appendChild(t)}class q{constructor(e){this.rootZoneId=e,this.cache=new WeakMap}setGenericStyles(){this.genericStyle=Y(q.generateStyles("[data-drop-zone-id]:hover",{"background-color":"inherit",color:"inherit"}))}clearGenericStyles(){void 0!==this.genericStyle&&(this.genericStyle.remove(),this.genericStyle=void 0)}setRange(e){const t=Y(q.generateStyles(L(e)?`[data-root-drop-zone="${this.rootZoneId}"] [data-drop-zone-id]`:`[data-drop-zone-id^="${e[G]}"]`,{"background-color":"var(--highlighted-bg) !important",color:"var(--highlighted-fg) !important"}));this.cache.set(e,t)}clearRange(e){const t=this.cache.get(e);void 0!==t&&(t.remove(),this.cache.delete(e))}static generateStyles(e,t){return`\n      ${e} { ${X(t)} }\n    `}}class J{constructor(){this.dropPermissions=new Map,this.id=J.seed++,this.highlighter=new q(this.id),this.ghost=new W}clear(){void 0!==this.currentDragZone&&this.highlighter.clearRange(this.currentDragZone),this.highlighter.clearGenericStyles(),void 0!==this.collapseTimeout&&(this.collapseTimeout=clearTimeout(this.collapseTimeout)),this.initialNode=void 0,this.initialDragZone=void 0,this.currentDragZone=void 0,this.dropPermissions.clear()}}J.seed=0;const Q=t({store:new U,draggable:new J}),V=t({}),ee=({store:e,className:t,innerClassName:i,itemClassName:r,children:s})=>{const d={draggable:n(new J).current,store:e},a={itemClassName:r,innerClassName:i,className:t};return o(Q.Provider,{value:d},o(V.Provider,{value:a},s))},te=e=>{return i(V)[e]},ne=e=>e.map((e,t)=>{const{divider:n,children:i}=e,r=T(e,["divider","children"]);return n?o(y.Divider,Object.assign({key:t},r)):o(y.Item,Object.assign({key:t},r),i&&i.length?ne(i):null)}),oe=e=>o(y,null,ne(e.items));function ie(){return i(Q).draggable}function re(){return i(Q).store}const se=(e,t)=>{const n=re();return r(o=>{n.emit(e,o,t)},[n,e,t])},de=({children:e,className:t,style:n})=>{const i=re(),d=ie();s(()=>()=>{d.clear()},[d]);const a=r(e=>{void 0!==d.currentDragZone&&d.dropPermissions.get(d.currentDragZone.id)&&e.preventDefault()},[d]),l=r(()=>{d.clear()},[d]),c=r(e=>{e.preventDefault();const{initialNode:t,currentDragZone:n}=d;if(void 0!==t&&void 0!==n)try{i.emit(k.Drop,t,n)}catch(e){console.error("Exception thrown in drop handler",e)}d.clear()},[d,i]);return o("div",{className:t,style:n,"data-root-drop-zone":d.id,onDrop:c,onDragOver:a,onDragEnd:l},e)},ae=E(e=>{const{node:t,nodes:n,autoExpandDelay:s,canDrop:d,canDrag:a,rowHeight:l,rowRenderer:c,className:p}=e,h=T(e,["node","nodes","autoExpandDelay","canDrop","canDrag","rowHeight","rowRenderer","className"]),{draggable:u}=i(Q),g=re(),m=S(t)?t:z(n,t),f=r(e=>{const{dropPermissions:n,currentDragZone:o,initialDragZone:i,collapseTimeout:r,initialNode:a,highlighter:l}=u;if(void 0!==r&&(u.collapseTimeout=clearTimeout(r)),void 0===i||void 0===a)return;let c=n.get(e.id);void 0===c&&(c=void 0===d||d(a,e),n.set(e.id,!!c)),void 0!==o&&l.clearRange(o),e.id!==i.id&&c?(u.currentDragZone=e,l.setRange(e),S(t)&&(u.collapseTimeout=setTimeout(g.toggleExpand,s,t,!0))):u.currentDragZone=void 0},[t,g.toggleExpand,m,u,d]),v=r(()=>{f(m)},[m,f]),y=r(e=>{if(void 0!==a&&!a(t))return void e.preventDefault();u.currentDragZone=m,u.initialDragZone=m,u.initialNode=t;const o=z(n,t);o&&u.dropPermissions.set(o.id,!1),u.highlighter.setGenericStyles(),e.dataTransfer.effectAllowed="copyMove",e.dataTransfer.setData("text/plain",t.id),u.ghost.content=t.name,u.ghost.attach(e),S(t)&&g.toggleExpand(t,!1)},[t,g.toggleExpand,u,a]),N=r(e=>{e.relatedTarget&&"closest"in e.relatedTarget&&!e.relatedTarget.closest("[data-drop-zone-id]")&&e.relatedTarget.closest("[data-root-drop-zone]")&&f(H)},[f]);return o("div",Object.assign({},h,{className:p,draggable:!0,onDragStart:y,onDragEnter:v,onDragLeave:N}))}),le={[j.Down]:{default:"chevron-down"},[j.Right]:{default:"chevron-right"}},ce=e=>{var{expanded:t,node:n,store:i,children:r}=e;T(e,["expanded","node","store","children"]);let s=null;if(S(n)){const e=t?j.Down in i?i[j.Down]:le[j.Down]:j.Right in i?i[j.Right]:le[j.Right],r="function"==typeof e?e(n):e;r&&(s=o(b,{iconSize:11,icon:r.default,className:D(r.color&&`text-${r.color}`)}))}return o("span",{className:"TreeListItem__caret"},s)},pe=({expanded:e,store:t,node:n})=>{const i=n.type&&t[n.type]||void 0,r="function"==typeof i?i(n):i;if(!r)return null;const s=e&&r.expanded||r.default;return o("span",{className:"TreeListItem__icon"},"blank"!==s?o(b,{icon:s,color:r.color}):null)},he=({node:e})=>{const t=re(),i=d(()=>z(t.nodes,e),[t.nodes,e]),[c,p]=a(null),[h,u]=a(e.name),g=n();s(()=>(g.current&&!g.current.state.isEditing&&(g.current.toggleEditing(),g.current.setTimeout(()=>{const e=(e=>e&&e.valueElement.previousElementSibling)(g.current);if(e){const t=e.value.indexOf(".");e.setSelectionRange(0,-1===t?e.value.length:t,"forward")}},16)),()=>g.current&&g.current.clearTimeouts()),[g.current]);const m=r(n=>{try{const o=Object.assign({},e,{name:n});t.emit(k.BeforeEditComplete,o,i),t.emit(k.AfterEditComplete,o,i)}catch(e){p(e.message)}},[t,e,i]),f=r(e=>{u(e),""!==e&&p(null)},[]),v=r(()=>{t.emit(k.EditCancel)},[t]);return o(l,null,o(x,{intent:null!==c?w.DANGER:w.NONE,ref:g,className:"TreeListItem__label",onConfirm:m,onCancel:v,onChange:f,value:h,placeholder:"",confirmOnEnterKey:!0}),null!==c&&o("div",{className:"TreeListItem__error"},c))},ue=E(e=>{const{data:t,index:n,style:i}=e,{nodes:s,rowRenderer:d,generateContextMenu:a,newNode:l,striped:c}=t,p=T(t,["nodes","rowRenderer","generateContextMenu","newNode","striped"]),h=te("itemClassName"),u=re(),g=M(s,n,l),m=u.isNodeExpanded(g),f=D(`TreeListItem TreeListItem--${g.level}`,g.className,h,{"TreeListItem--active":u.activeNodeId===g.id,"TreeListItem--striped":c&&n%2!=0}),v=se(k.NodeClick,g),y=se(k.NodeCaretClick,g),b=se(k.NodeMouseEnter,g),x=se(k.NodeMouseLeave,g),w=((e,t)=>{const{activeNodeId:n}=re(),i=ie();return r(r=>{if(r.preventDefault(),!t)return;const s=t(e);s&&s.length&&(n!==e.id&&i.highlighter.setRange(e),N.show(o(oe,{items:s}),{left:r.clientX,top:r.clientY},()=>{i.highlighter.clearRange(e)}))},[t,n,i,e])})(g,a),E=u.editedNodeId===g.id,C=u.knownPossibleDepth>0;let O;return O="function"==typeof d?d(g,{isEdited:E,isExpanded:m}):o("div",{className:"flex-1 flex items-center",style:Object.assign({paddingLeft:15*g.level},g.style)},C&&o(ce,{onClick:y,expanded:m,store:u.icons,node:g}),o(pe,{expanded:m,store:u.icons,node:g}),u.editedNodeId===g.id?o(he,{node:g}):o("span",{className:"TreeListItem__label",title:g.name},g.name)),u.editedNodeId===g.id?o("div",{key:g.id,className:f,style:i},O):o(ae,Object.assign({key:g.id,className:f,"data-drop-zone-id":g[G],node:g,onClick:v,onMouseEnter:b,onMouseLeave:x,onContextMenu:w,nodes:s,style:i},p),O)}),ge=E(e=>{const{autoExpandDelay:t=B,rowHeight:i=K,rowRenderer:s,canDrag:d,canDrop:a,generateContextMenu:l,style:c,striped:p,maxRows:h,interactive:u=!0}=e,g=te("className"),m=te("innerClassName"),f=re(),v=n(null),y=f.filteredNodes,N=y.length+(void 0!==f.newNode?1:0),b={className:m,itemData:{canDrag:d,canDrop:a,autoExpandDelay:t,rowRenderer:s,rowHeight:i,nodes:y,generateContextMenu:l,newNode:f.newNode,striped:p},itemKey:r(e=>M(y,e,f.newNode).id,[y,f.newNode]),itemSize:i,itemCount:N,ref:v,maxRows:h};return 0===N?null:o(de,{style:c,className:D(g,"TreeList",u&&"TreeList--interactive",!h&&"h-full")},o(C,Object.assign({},b),ue))}),me=({error:e})=>o("div",{className:"p-4"},o("b",null,"Error"),e&&`: ${e.message}`),fe=e=>{var{onError:t,FallbackComponent:n=me,store:i,className:r,innerClassName:s,itemClassName:d}=e,a=T(e,["onError","FallbackComponent","store","className","innerClassName","itemClassName"]);return o(O,{onError:t,FallbackComponent:n},o(ee,{store:i,className:r,itemClassName:d,innerClassName:s},o(ge,Object.assign({},a))))};fe.displayName="TreeList";export{B as DEFAULT_AUTO_EXPAND_DELAY,K as DEFAULT_ITEM_SIZE,G as DROP_ZONE_ID,F as NODE_PADDING_MULTIPLIER,fe as TreeList,j as TreeListCaretIcons,k as TreeListEvents,U as TreeStore,_ as findNodeIndex,z as getParent,A as getRange,$ as getSiblings,M as getTreeListItemNode,S as isContainer,Z as isNew,L as isRoot,H as root};
