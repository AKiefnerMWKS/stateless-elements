"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),lifecycle=require("@stoplight/lifecycle"),mobx=require("mobx"),uiKit=require("@stoplight/ui-kit"),cn=_interopDefault(require("classnames")),mobxReactLite=require("mobx-react-lite"),ScrollList=require("@stoplight/ui-kit/ScrollList"),ErrorBoundary=_interopDefault(require("react-error-boundary"));function __rest(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&(o[r[n]]=e[r[n]])}return o}function __decorate(e,t,o,r){var n,a=arguments.length,i=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(i=(a<3?n(i):a>3?n(t,o,i):n(t,o))||i);return a>3&&i&&Object.defineProperty(t,o,i),i}function __metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function __awaiter(e,t,o,r){return new(o||(o=Promise))(function(n,a){function i(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){e.done?n(e.value):new o(function(t){t(e.value)}).then(i,s)}l((r=r.apply(e,t||[])).next())})}!function(e){e.NodeClick="node.click",e.NodeMouseEnter="node.mouseenter",e.NodeMouseLeave="node.mouseexit",e.NodeDoubleClick="node.doubleClick",e.NodeCaretClick="node.caretClick",e.Drop="drop",e.EditCancel="edit.cancel",e.BeforeEditComplete="edit.beforecomplete",e.AfterEditComplete="edit.aftercomplete"}(exports.TreeListEvents||(exports.TreeListEvents={})),function(e){e.Right="right",e.Down="down"}(exports.TreeListCaretIcons||(exports.TreeListCaretIcons={}));const isContainer=e=>"canHaveChildren"in e&&!!e.canHaveChildren,isRoot=e=>null===e.id,isNew=e=>"index"in e,findNodeIndex=(e,t)=>isNew(t)?t.index:e.findIndex(({id:e})=>t.id===e),getTreeListItemNode=(e,t,o)=>void 0===o||o.index>t?e[t]:o.index===t?o:e[t-1],getParent=(e,t)=>{if(0===t.level)return root;let o=findNodeIndex(e,t);if(-1===o)return;if(0===o)return root;let r=t;for(;o>0&&r.level!==t.level-1;)r=e[--o];return r},getRange=(e,t,o)=>{let r=0;if(!isRoot(t)){if(-1===(r=findNodeIndex(e,t)))return[];r++}const n=isRoot(t)?[]:[t];for(;r<e.length;){const a=e[r];if(void 0!==o&&o.id===a.id)break;if(!isRoot(t)&&a.level<=t.level)break;n.push(e[r]),r++}return n},getSiblings=(e,t)=>{const o=findNodeIndex(e,t),r=[];let n=o,a=o;for(;--n>=0;){const o=e[n];if(o.level===t.level-1)break;o.level===t.level&&r.push(o)}for(;++a<e.length;){const o=e[a];if(o.level===t.level-1)break;o.level===t.level&&r.push(o)}return r},root=Object.freeze({id:null}),DROP_ZONE_ID=Symbol("DROP_ZONE_ID"),DEFAULT_AUTO_EXPAND_DELAY=800,NODE_PADDING_MULTIPLIER=15,DEFAULT_ITEM_SIZE=30;mobx.configure({enforceActions:"observed"});class TreeStore extends(lifecycle.createEventEmitter()){constructor(e){super(),this.nodes=[],this.expanded={},this.icons={},this.defaultExpandedDepth=0,this.setActiveNode=(e=>{this.activeNodeId=e}),this.setEditedNode=(e=>{this.editedNodeId=e}),this.toggleExpand=((e,t)=>{const{expanded:o}=this;"boolean"==typeof t&&t===o[e.id]||(this.expanded[e.id]=void 0!==t?t:!this.isNodeExpanded(e))}),this._knownPossibleDepth=0,this.create=((e,t,o)=>__awaiter(this,void 0,void 0,function*(){let r=0;if(null!==e&&-1===(r=this.filteredNodes.findIndex(({id:t})=>t===e.id)))throw new Error(`Node with id: ${e.id} was not found.`);const n=null===e?root:this.filteredNodes[r++];if(isRoot(n)||isContainer(n)){isRoot(n)||this.toggleExpand(n,!0);const e=Object.assign({name:"",id:""},t,{index:r,level:isRoot(n)?0:n.level+1});mobx.runInAction(()=>{this.newNode=e});try{return yield this.rename(e,o)}finally{mobx.runInAction(()=>{this.newNode=void 0})}}throw new Error})),this.rename=((e,t)=>__awaiter(this,void 0,void 0,function*(){this.setEditedNode(e.id);const o=new lifecycle.DisposableCollection;try{return yield new Promise((e,r)=>{o.pushAll([this.on(exports.TreeListEvents.BeforeEditComplete,(e,o)=>{void 0!==t&&t(e,o)}),this.on(exports.TreeListEvents.AfterEditComplete,e),this.on(exports.TreeListEvents.EditCancel,r)])})}finally{o.dispose(),this.setEditedNode()}})),void 0!==e&&Object.assign(this,e)}isNodeExpanded(e){return!(e.id in this.expanded)&&e.level<=this.defaultExpandedDepth||!0===this.expanded[e.id]}get knownPossibleDepth(){return this._knownPossibleDepth}get filteredNodes(){const e=[];if(0===this.nodes.length)return this._knownPossibleDepth=0,e;const t=[""];let o=null;for(const r of this.nodes){const n=null===o||o.level>=r.level;n&&!this.isNodeExpanded(r)&&(o=r),r.canHaveChildren&&r.level+1>this.knownPossibleDepth&&(this._knownPossibleDepth=r.level+1),t.length=r.level+1,t[t.length-1]=r.id,void 0===r[DROP_ZONE_ID]&&(r[DROP_ZONE_ID]=`-${t.join("-")}-`),n&&(o!==r&&(o=null),e.push(r))}return e}}__decorate([mobx.observable,__metadata("design:type",String)],TreeStore.prototype,"activeNodeId",void 0),__decorate([mobx.observable,__metadata("design:type",String)],TreeStore.prototype,"editedNodeId",void 0),__decorate([mobx.observable.ref,__metadata("design:type",Object)],TreeStore.prototype,"newNode",void 0),__decorate([mobx.observable.shallow,__metadata("design:type",Array)],TreeStore.prototype,"nodes",void 0),__decorate([mobx.observable,__metadata("design:type",Object)],TreeStore.prototype,"expanded",void 0),__decorate([mobx.observable,__metadata("design:type",Object)],TreeStore.prototype,"icons",void 0),__decorate([mobx.observable,__metadata("design:type",Object)],TreeStore.prototype,"defaultExpandedDepth",void 0),__decorate([mobx.action,__metadata("design:type",Object)],TreeStore.prototype,"setActiveNode",void 0),__decorate([mobx.action,__metadata("design:type",Object)],TreeStore.prototype,"setEditedNode",void 0),__decorate([mobx.action,__metadata("design:type",Object)],TreeStore.prototype,"toggleExpand",void 0),__decorate([mobx.computed,__metadata("design:type",Object),__metadata("design:paramtypes",[])],TreeStore.prototype,"filteredNodes",null),__decorate([mobx.action,__metadata("design:type",Object)],TreeStore.prototype,"create",void 0),__decorate([mobx.action,__metadata("design:type",Object)],TreeStore.prototype,"rename",void 0);class Ghost{constructor(){this.attach=(e=>{document.body.appendChild(this.node),e.dataTransfer.setDragImage(this.node,-10,-10),setTimeout(this.detach,0)}),this.detach=(()=>{this.node.remove()}),this.node=document.createElement("span"),this.node.className=cn(uiKit.Classes.TAG,uiKit.Classes.ROUND)}get content(){return this.node.textContent}set content(e){this.node.textContent=e}}const joinCSSRules=e=>Object.entries(e).map(e=>e.join(":")).join(";");function getHighlightStyles(){return{"background-color":"var(--highlighted-bg) !important",color:"var(--highlighted-fg) !important"}}function getGenericStyles(){return{"background-color":"inherit",color:"inherit"}}function createStyleNode(e){const t=document.createElement("style");return t.textContent=e,document.body.appendChild(t)}class Highlighter{constructor(e){this.rootZoneId=e,this.cache=new WeakMap}setGenericStyles(){this.genericStyle=createStyleNode(Highlighter.generateStyles("[data-drop-zone-id]:hover",getGenericStyles()))}clearGenericStyles(){void 0!==this.genericStyle&&(this.genericStyle.remove(),this.genericStyle=void 0)}setRange(e){const t=createStyleNode(Highlighter.generateStyles(isRoot(e)?`[data-root-drop-zone="${this.rootZoneId}"] [data-drop-zone-id]`:`[data-drop-zone-id^="${e[DROP_ZONE_ID]}"]`,getHighlightStyles()));this.cache.set(e,t)}clearRange(e){const t=this.cache.get(e);void 0!==t&&(t.remove(),this.cache.delete(e))}static generateStyles(e,t){return`\n      ${e} { ${joinCSSRules(t)} }\n    `}}class DraggableInstance{constructor(){this.dropPermissions=new Map,this.id=DraggableInstance.seed++,this.highlighter=new Highlighter(this.id),this.ghost=new Ghost}clear(){void 0!==this.currentDragZone&&this.highlighter.clearRange(this.currentDragZone),this.highlighter.clearGenericStyles(),void 0!==this.collapseTimeout&&(this.collapseTimeout=clearTimeout(this.collapseTimeout)),this.initialNode=void 0,this.initialDragZone=void 0,this.currentDragZone=void 0,this.dropPermissions.clear()}}DraggableInstance.seed=0;const defaultContext={store:new TreeStore,draggable:new DraggableInstance},TreeContext=React.createContext(defaultContext),ClassNamesContext=React.createContext({}),TreeListProvider=({store:e,className:t,innerClassName:o,itemClassName:r,children:n})=>{const a={draggable:React.useRef(new DraggableInstance).current,store:e},i={itemClassName:r,innerClassName:o,className:t};return React.createElement(TreeContext.Provider,{value:a},React.createElement(ClassNamesContext.Provider,{value:i},n))},useClassName=e=>{return React.useContext(ClassNamesContext)[e]},createMenu=e=>e.map((e,t)=>{const{divider:o,children:r}=e,n=__rest(e,["divider","children"]);return o?React.createElement(uiKit.Menu.Divider,Object.assign({key:t},n)):React.createElement(uiKit.Menu.Item,Object.assign({key:t},n),r&&r.length?createMenu(r):null)}),TreeListContextMenu=e=>React.createElement(uiKit.Menu,null,createMenu(e.items));function useDraggable(){return React.useContext(TreeContext).draggable}function useStore(){return React.useContext(TreeContext).store}const useContextMenu=(e,t)=>{const{activeNodeId:o}=useStore(),r=useDraggable();return React.useCallback(n=>{if(n.preventDefault(),!t)return;const a=t(e);a&&a.length&&(o!==e.id&&r.highlighter.setRange(e),uiKit.ContextMenu.show(React.createElement(TreeListContextMenu,{items:a}),{left:n.clientX,top:n.clientY},()=>{r.highlighter.clearRange(e)}))},[t,o,r,e])},useNodeCallback=(e,t)=>{const o=useStore();return React.useCallback(r=>{o.emit(e,r,t)},[o,e,t])},DraggableContainer=({children:e,className:t,style:o})=>{const r=useStore(),n=useDraggable();React.useEffect(()=>()=>{n.clear()},[n]);const a=React.useCallback(e=>{void 0!==n.currentDragZone&&n.dropPermissions.get(n.currentDragZone.id)&&e.preventDefault()},[n]),i=React.useCallback(()=>{n.clear()},[n]),s=React.useCallback(e=>{e.preventDefault();const{initialNode:t,currentDragZone:o}=n;if(void 0!==t&&void 0!==o)try{r.emit(exports.TreeListEvents.Drop,t,o)}catch(e){console.error("Exception thrown in drop handler",e)}n.clear()},[n,r]);return React.createElement("div",{className:t,style:o,"data-root-drop-zone":n.id,onDrop:s,onDragOver:a,onDragEnd:i},e)},DraggableItem=mobxReactLite.observer(e=>{const{node:t,nodes:o,autoExpandDelay:r,canDrop:n,canDrag:a,rowHeight:i,rowRenderer:s,className:l}=e,c=__rest(e,["node","nodes","autoExpandDelay","canDrop","canDrag","rowHeight","rowRenderer","className"]),{draggable:d}=React.useContext(TreeContext),u=useStore(),p=isContainer(t)?t:getParent(o,t),g=React.useCallback(e=>{const{dropPermissions:o,currentDragZone:a,initialDragZone:i,collapseTimeout:s,initialNode:l,highlighter:c}=d;if(void 0!==s&&(d.collapseTimeout=clearTimeout(s)),void 0===i||void 0===l)return;let p=o.get(e.id);void 0===p&&(p=void 0===n||n(l,e),o.set(e.id,!!p)),void 0!==a&&c.clearRange(a),e.id!==i.id&&p?(d.currentDragZone=e,c.setRange(e),isContainer(t)&&(d.collapseTimeout=setTimeout(u.toggleExpand,r,t,!0))):d.currentDragZone=void 0},[t,u.toggleExpand,p,d,n]),m=React.useCallback(()=>{g(p)},[p,g]),h=React.useCallback(e=>{if(void 0!==a&&!a(t))return void e.preventDefault();d.currentDragZone=p,d.initialDragZone=p,d.initialNode=t;const r=getParent(o,t);r&&d.dropPermissions.set(r.id,!1),d.highlighter.setGenericStyles(),e.dataTransfer.effectAllowed="copyMove",e.dataTransfer.setData("text/plain",t.id),d.ghost.content=t.name,d.ghost.attach(e),isContainer(t)&&u.toggleExpand(t,!1)},[t,u.toggleExpand,d,a]),v=React.useCallback(e=>{e.relatedTarget&&"closest"in e.relatedTarget&&!e.relatedTarget.closest("[data-drop-zone-id]")&&e.relatedTarget.closest("[data-root-drop-zone]")&&g(root)},[g]);return React.createElement("div",Object.assign({},c,{className:l,draggable:!0,onDragStart:h,onDragEnter:m,onDragLeave:v}))}),DEFAULT_CARET_ICONS={[exports.TreeListCaretIcons.Down]:{default:"chevron-down"},[exports.TreeListCaretIcons.Right]:{default:"chevron-right"}},NodeCaret=e=>{var{expanded:t,node:o,store:r,children:n}=e;__rest(e,["expanded","node","store","children"]);let a=null;if(isContainer(o)){const e=t?exports.TreeListCaretIcons.Down in r?r[exports.TreeListCaretIcons.Down]:DEFAULT_CARET_ICONS[exports.TreeListCaretIcons.Down]:exports.TreeListCaretIcons.Right in r?r[exports.TreeListCaretIcons.Right]:DEFAULT_CARET_ICONS[exports.TreeListCaretIcons.Right],n="function"==typeof e?e(o):e;n&&(a=React.createElement(uiKit.Icon,{iconSize:11,icon:n.default,className:cn(n.color&&`text-${n.color}`)}))}return React.createElement("span",{className:"TreeListItem__caret"},a)},NodeIcon=({expanded:e,store:t,node:o})=>{const r=o.type&&t[o.type]||void 0,n="function"==typeof r?r(o):r;if(!n)return null;const a=e&&n.expanded||n.default;return React.createElement("span",{className:"TreeListItem__icon"},"blank"!==a?React.createElement(uiKit.Icon,{icon:a,color:n.color}):null)},getFieldInput=e=>e&&e.valueElement.previousElementSibling,EditableItem=({node:e})=>{const t=useStore(),o=React.useMemo(()=>getParent(t.nodes,e),[t.nodes,e]),[r,n]=React.useState(null),[a,i]=React.useState(e.name),s=React.useRef();React.useEffect(()=>(s.current&&!s.current.state.isEditing&&(s.current.toggleEditing(),s.current.setTimeout(()=>{const e=getFieldInput(s.current);if(e){const t=e.value.indexOf(".");e.setSelectionRange(0,-1===t?e.value.length:t,"forward")}},16)),()=>s.current&&s.current.clearTimeouts()),[s.current]);const l=React.useCallback(r=>{try{const a=Object.assign({},e,{name:r});t.emit(exports.TreeListEvents.BeforeEditComplete,a,o),t.emit(exports.TreeListEvents.AfterEditComplete,a,o)}catch(e){n(e.message)}},[t,e,o]),c=React.useCallback(e=>{i(e),""!==e&&n(null)},[]),d=React.useCallback(()=>{t.emit(exports.TreeListEvents.EditCancel)},[t]);return React.createElement(React.Fragment,null,React.createElement(uiKit.EditableText,{intent:null!==r?uiKit.Intent.DANGER:uiKit.Intent.NONE,ref:s,className:"TreeListItem__label",onConfirm:l,onCancel:d,onChange:c,value:a,placeholder:"",confirmOnEnterKey:!0}),null!==r&&React.createElement("div",{className:"TreeListItem__error"},r))},TreeListItem=mobxReactLite.observer(e=>{const{data:t,index:o,style:r}=e,{nodes:n,rowRenderer:a,generateContextMenu:i,newNode:s,striped:l}=t,c=__rest(t,["nodes","rowRenderer","generateContextMenu","newNode","striped"]),d=useClassName("itemClassName"),u=useStore(),p=getTreeListItemNode(n,o,s),g=u.isNodeExpanded(p),m=cn(`TreeListItem TreeListItem--${p.level}`,p.className,d,{"TreeListItem--active":u.activeNodeId===p.id,"TreeListItem--striped":l&&o%2!=0}),h=useNodeCallback(exports.TreeListEvents.NodeClick,p),v=useNodeCallback(exports.TreeListEvents.NodeCaretClick,p),x=useNodeCallback(exports.TreeListEvents.NodeMouseEnter,p),f=useNodeCallback(exports.TreeListEvents.NodeMouseLeave,p),b=useContextMenu(p,i),E=u.editedNodeId===p.id,N=u.knownPossibleDepth>0;let _;return _="function"==typeof a?a(p,{isEdited:E,isExpanded:g}):React.createElement("div",{className:"flex-1 flex items-center",style:Object.assign({paddingLeft:15*p.level},p.style)},N&&React.createElement(NodeCaret,{onClick:v,expanded:g,store:u.icons,node:p}),React.createElement(NodeIcon,{expanded:g,store:u.icons,node:p}),u.editedNodeId===p.id?React.createElement(EditableItem,{node:p}):React.createElement("span",{className:"TreeListItem__label",title:p.name},p.name)),u.editedNodeId===p.id?React.createElement("div",{key:p.id,className:m,style:r},_):React.createElement(DraggableItem,Object.assign({key:p.id,className:m,"data-drop-zone-id":p[DROP_ZONE_ID],node:p,onClick:h,onMouseEnter:x,onMouseLeave:f,onContextMenu:b,nodes:n,style:r},c),_)}),TreeListComponent=mobxReactLite.observer(e=>{const{autoExpandDelay:t=DEFAULT_AUTO_EXPAND_DELAY,rowHeight:o=DEFAULT_ITEM_SIZE,rowRenderer:r,canDrag:n,canDrop:a,generateContextMenu:i,style:s,striped:l,maxRows:c,interactive:d=!0}=e,u=useClassName("className"),p=useClassName("innerClassName"),g=useStore(),m=React.useRef(null),h=g.filteredNodes,v=h.length+(void 0!==g.newNode?1:0),x={className:p,itemData:{canDrag:n,canDrop:a,autoExpandDelay:t,rowRenderer:r,rowHeight:o,nodes:h,generateContextMenu:i,newNode:g.newNode,striped:l},itemKey:React.useCallback(e=>getTreeListItemNode(h,e,g.newNode).id,[h,g.newNode]),itemSize:o,itemCount:v,ref:m,maxRows:c};return 0===v?null:React.createElement(DraggableContainer,{style:s,className:cn(u,"TreeList",d&&"TreeList--interactive",!c&&"h-full")},React.createElement(ScrollList.FixedSizeList,Object.assign({},x),TreeListItem))}),TreeListFallbackComponent=({error:e})=>React.createElement("div",{className:"p-4"},React.createElement("b",null,"Error"),e&&`: ${e.message}`),TreeList=e=>{var{onError:t,FallbackComponent:o=TreeListFallbackComponent,store:r,className:n,innerClassName:a,itemClassName:i}=e,s=__rest(e,["onError","FallbackComponent","store","className","innerClassName","itemClassName"]);return React.createElement(ErrorBoundary,{onError:t,FallbackComponent:o},React.createElement(TreeListProvider,{store:r,className:n,itemClassName:i,innerClassName:a},React.createElement(TreeListComponent,Object.assign({},s))))};TreeList.displayName="TreeList",exports.DEFAULT_AUTO_EXPAND_DELAY=DEFAULT_AUTO_EXPAND_DELAY,exports.DEFAULT_ITEM_SIZE=DEFAULT_ITEM_SIZE,exports.DROP_ZONE_ID=DROP_ZONE_ID,exports.NODE_PADDING_MULTIPLIER=15,exports.TreeList=TreeList,exports.TreeStore=TreeStore,exports.findNodeIndex=findNodeIndex,exports.getParent=getParent,exports.getRange=getRange,exports.getSiblings=getSiblings,exports.getTreeListItemNode=getTreeListItemNode,exports.isContainer=isContainer,exports.isNew=isNew,exports.isRoot=isRoot,exports.root=root;
